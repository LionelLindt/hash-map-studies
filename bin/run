#!/usr/bin/env ruby
require 'timeout'
require_relative '../lib/hash_map'
require_relative '../lib/optimizer_repository'

Dir['optimizers/**/*.rb'].sort.each { |f| require_relative "../#{f}" }

seed = (ENV['RANDOM_SEED'] || Random.new_seed).to_i
Kernel.srand seed
puts "Initializing experiment with random seed #{seed}"

def with_all_samples
  ['numeric_keys'].each do |sample_name|
    sample_keys = File.read("spec/data/#{sample_name}.txt").split(/\W+/).shuffle
    yield(sample_name, sample_keys)
  end
end

def try_experiment(hash_map, sample_keys)
  Timeout.timeout(60) do
    sample_keys.each { |key| hash_map[key] = :dummy_value }
  end

  raise 'Element could not be found' if sample_keys.one? { |key| hash_map[key].nil? }
rescue StandardError => e
  "! #{e.message}"
else
  "#{hash_map.total_collision_count} collisions, #{hash_map.fill_level} fill"
end

OptimizerRepository.all.each do |locator|
  strategy_report = "Strategy: #{locator[:name]}\n"

  with_all_samples do |sample_name, sample_keys|
    hash_map = HashMap.new.with_locator(&locator[:locator])
    experiment_report = try_experiment(hash_map, sample_keys)
    strategy_report << "  #{sample_name}: #{experiment_report}\n"
  end

  puts strategy_report
end
